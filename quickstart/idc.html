<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>阶段2 向他人服务 | Bird Wiki</title><meta name="description" content="一篇关于bird的百科（或者手册）">
    <link rel="modulepreload" href="/assets/app.6747bec2.js"><link rel="modulepreload" href="/assets/idc.html.be8448a3.js"><link rel="modulepreload" href="/assets/idc.html.1524ab3c.js"><link rel="prefetch" href="/assets/index.html.c899f7c1.js"><link rel="prefetch" href="/assets/index.html.f6fa193b.js"><link rel="prefetch" href="/assets/index.html.59fe1616.js"><link rel="prefetch" href="/assets/after.html.0aed882b.js"><link rel="prefetch" href="/assets/before.html.7f9740b4.js"><link rel="prefetch" href="/assets/multi_location.html.f2588af9.js"><link rel="prefetch" href="/assets/player.html.4fc3615f.js"><link rel="prefetch" href="/assets/index.html.9fa01890.js"><link rel="prefetch" href="/assets/index.html.6fa58f93.js"><link rel="prefetch" href="/assets/index.html.661864ac.js"><link rel="prefetch" href="/assets/404.html.d2dc3323.js"><link rel="prefetch" href="/assets/index.html.481e7143.js"><link rel="prefetch" href="/assets/index.html.dfa4ba4b.js"><link rel="prefetch" href="/assets/index.html.25f5b183.js"><link rel="prefetch" href="/assets/after.html.d5101399.js"><link rel="prefetch" href="/assets/before.html.90856bf8.js"><link rel="prefetch" href="/assets/multi_location.html.2811c5c7.js"><link rel="prefetch" href="/assets/player.html.d6b7d025.js"><link rel="prefetch" href="/assets/index.html.30debefb.js"><link rel="prefetch" href="/assets/index.html.269ba93e.js"><link rel="prefetch" href="/assets/index.html.1c8fe48a.js"><link rel="prefetch" href="/assets/404.html.f7378eeb.js">
    <link rel="stylesheet" href="/assets/style.3db455f5.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">Bird Wiki</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/quickstart/" class="router-link-active" aria-label="快速开始"><!--[--><!--]--> 快速开始 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/quickstart/" class="router-link-active" aria-label="快速开始"><!--[--><!--]--> 快速开始 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/quickstart/" class="router-link-active sidebar-item sidebar-heading" aria-label="简介"><!--[--><!--]--> 简介 <!--[--><!--]--></a><!----></li><li><a href="/quickstart/before.html" class="sidebar-item sidebar-heading" aria-label="开始之前"><!--[--><!--]--> 开始之前 <!--[--><!--]--></a><!----></li><li><a href="/quickstart/player.html" class="sidebar-item sidebar-heading" aria-label="阶段1 BGP Player"><!--[--><!--]--> 阶段1 BGP Player <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="阶段2 向他人服务"><!--[--><!--]--> 阶段2 向他人服务 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/quickstart/idc.html#前言" class="router-link-active router-link-exact-active sidebar-item" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#开始之前" class="router-link-active router-link-exact-active sidebar-item" aria-label="开始之前"><!--[--><!--]--> 开始之前 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="概念"><!--[--><!--]--> 概念 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/quickstart/idc.html#irr" class="router-link-active router-link-exact-active sidebar-item" aria-label="IRR"><!--[--><!--]--> IRR <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#rpki" class="router-link-active router-link-exact-active sidebar-item" aria-label="RPKI"><!--[--><!--]--> RPKI <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#上下游和对等" class="router-link-active router-link-exact-active sidebar-item" aria-label="上下游和对等"><!--[--><!--]--> 上下游和对等 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#as-set" class="router-link-active router-link-exact-active sidebar-item" aria-label="AS-SET"><!--[--><!--]--> AS-SET <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#bgp-community" class="router-link-active router-link-exact-active sidebar-item" aria-label="BGP Community"><!--[--><!--]--> BGP Community <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/quickstart/idc.html#过滤器" class="router-link-active router-link-exact-active sidebar-item" aria-label="过滤器"><!--[--><!--]--> 过滤器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/quickstart/idc.html#规则" class="router-link-active router-link-exact-active sidebar-item" aria-label="规则"><!--[--><!--]--> 规则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#上下游对等与自我路由的区分" class="router-link-active router-link-exact-active sidebar-item" aria-label="上下游对等与自我路由的区分"><!--[--><!--]--> 上下游对等与自我路由的区分 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/quickstart/idc.html#实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="实现"><!--[--><!--]--> 实现 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a href="/quickstart/multi_location.html" class="sidebar-item sidebar-heading" aria-label="阶段3 多地部署"><!--[--><!--]--> 阶段3 多地部署 <!--[--><!--]--></a><!----></li><li><a href="/quickstart/after.html" class="sidebar-item sidebar-heading" aria-label="/quickstart/after.md"><!--[--><!--]--> /quickstart/after.md <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="向他人服务" tabindex="-1"><a class="header-anchor" href="#向他人服务" aria-hidden="true">#</a> 向他人服务</h1><p>在这篇文章中，我们将讲述在给他人提供服务的时候，应该如何搭建一个更可靠的BGP系统。</p><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>我个人认为，这一部分会比较重要。</p><h2 id="开始之前" tabindex="-1"><a class="header-anchor" href="#开始之前" aria-hidden="true">#</a> 开始之前</h2><p>我们假设：</p><ul><li><p>你只拥有IPv6段</p></li><li><p>你的ASN是 <code>AS114514</code></p></li><li><p>你的IPv6段为 <code>2404::/48</code>，你计划能使用 <code>2404::1</code>访问这台机器</p></li><li><p>该机器的公网IPv4为 <code>1.1.1.1</code> 公网IPv6为 <code>2405::1</code></p></li><li><p>你的BGP上游为<code>AS7720</code>，对方的IPv6为<code>2405::2</code>，对方的IPv6前缀为<code>2404:1::/48</code></p></li><li><p>你的BGP下游为<code>AS218072</code>，对方的IPv6为<code>2405::3</code>，对方的IPv6前缀为<code>2404:2::/48</code></p></li><li><p>你的BGP对等为<code>AS6939</code>，对方的IPv6为<code>2405::4</code>，对方的IPv6前缀为<code>2404:3::/48</code></p></li><li><p>你与你的邻居在同一个子网且一跳可达</p></li></ul><p><strong>该设置将通用于本篇文章</strong></p><h2 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h2><h3 id="irr" tabindex="-1"><a class="header-anchor" href="#irr" aria-hidden="true">#</a> IRR</h3><p>IRR（Internet Routing Registry）是存储互联网路由对象的数据库，里面记录了某个前缀该被路由到哪个ASN。IRR实际上由很多个数据库组成，具体列表请看<a href="https://www.irr.net/docs/list.html" target="_blank" rel="noopener noreferrer">这里<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。五大RIR（ARIN，RIPE，AFRINIC，APNIC，LACNIC），比较老的T1（LEVEL3，NTTCOM）都有自己的IRR数据库，同时还有一个商业数据库RADb和一个非营利数据库ALTDB。这9个数据库是目前比较通用的数据库。</p><h3 id="rpki" tabindex="-1"><a class="header-anchor" href="#rpki" aria-hidden="true">#</a> RPKI</h3><p>关于RPKI的介绍我推荐查看<a href="https://blog.cloudflare.com/rpki/" target="_blank" rel="noopener noreferrer">这篇文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。简而言之，RPKI也可以用来将ASN与路由关联在一起，但与IRR的区别是RPKI需要使用证书签名，使用它可以有效地防止路由劫持。</p><h3 id="上下游和对等" tabindex="-1"><a class="header-anchor" href="#上下游和对等" aria-hidden="true">#</a> 上下游和对等</h3><p>在业务中，我们遇到的需要建立BGP的对象主要可以分为三类：上游，下游和对等。</p><h4 id="上游" tabindex="-1"><a class="header-anchor" href="#上游" aria-hidden="true">#</a> 上游</h4><p>上游（Upstream），即向你提供互联网服务（IP Transit）的对象，比如各类ISP。一般而言，上游一般会发送互联网的全部路由，即全表。对于某些业务，上游可能仅会发送一部分路由（例如中国优化路由）。</p><p>对于上游，我们应发送从自身和下游收到的路由。</p><h4 id="下游" tabindex="-1"><a class="header-anchor" href="#下游" aria-hidden="true">#</a> 下游</h4><p>下游（Downstream），即你向其提供互联网服务（IP Transit）的对象。</p><p>对于下游，我们应发送从自身、上游、下游、对等收到的表，即全表。对于特殊下游（例如路由优化业务），我们仅发送所需的路由。对于有IP段白名单的特殊上游，我们应仅向拥有白名单内IP段的下游发相关路由。</p><h4 id="对等" tabindex="-1"><a class="header-anchor" href="#对等" aria-hidden="true">#</a> 对等</h4><p>对等（Peer），通常而言是你/对方需要直接访问对方/你服务的对象，例如Cloudflare和Google。一般对等的目的是节省结算费用（通常楼内线的费用远小于同等带宽的IP Transit费用）。</p><p>对于对等，我们应发送从自身和下游收到的路由。</p><h4 id="发表" tabindex="-1"><a class="header-anchor" href="#发表" aria-hidden="true">#</a> 发表</h4><p>总而言之，发表可以总结为如下规则：</p><ul><li>上游和对等：仅发送从自身和下游收到的路由。</li><li>下游：一般发全表。对于特殊下游，根据所购买的服务发路由。对于有IP段白名单的特殊上游，我们应仅向拥有白名单内IP段的下游发相关路由。</li><li>路由优先级：下游&gt;对等&gt;上游</li></ul><h3 id="as-set" tabindex="-1"><a class="header-anchor" href="#as-set" aria-hidden="true">#</a> AS-SET</h3><p>AS-SET，顾名思义，一个AS的集合。一个AS-SET内通常要包含自己以及自己的下游的ASN。AS-SET允许嵌套。</p><h3 id="bgp-community" tabindex="-1"><a class="header-anchor" href="#bgp-community" aria-hidden="true">#</a> BGP Community</h3><p>BGP Community（也称BGP社区） 类似于给路由的标签，对等方可以根据标签内容来做出自己的选择。</p><p>BGP Community 有如下三种类型：</p><ul><li><code>BGP Community (BGP社区)</code>，为一个4字节的值，在Bird内显示为<code>(2byte ASN,2byte value)</code>，前二字节为ASN，后二字节由AS自由分配。由于使用它需要一个2byte的ASN（目前申请比较困难），所以一般在大ISP中能见到，或者使用保留ASN。</li><li><code>BGP Extended Community (BGP扩展社区)</code>，在鸟内一般表示为<code>(type,administrator,value)</code>，为一个八字节的值，前二字节为类型，后六字节为管理员和分配的编号，由AS自行分配。它比较著名的应用位于MPLS-VPN内。</li><li><code>BGP Large Community (BGP大型社区)</code>，在鸟内一般表示为<code>(4byte ASN,4byte value,4byte value)</code>，为一个12字节的值，前四字节为ASN，中间四字节与后四字节由AS自由分配。它被开发的主要原因是因为4字节ASN不能用于普通的BGP社区。</li></ul><p>目前，在公网上应用比较广的主要为<code>BGP Community</code>与<code>BGP Large Community</code></p><p>RFC要求所有支持BGP社区的路由器必须处理知名的BGP社区，也就是<code>NO_EXPORT</code>, <code>NO_ADVERTISE</code>和<code>NO_EXPORT_SUBCONFED</code>。在默认情况下，bird会自动处理这些BGP社区。</p><h2 id="过滤器" tabindex="-1"><a class="header-anchor" href="#过滤器" aria-hidden="true">#</a> 过滤器</h2><p><strong>过滤器非常的重要，做好自己的过滤是对与你建立BGP连接的人的尊敬，如果要为下游服务更是如此</strong></p><h3 id="规则" tabindex="-1"><a class="header-anchor" href="#规则" aria-hidden="true">#</a> 规则</h3><p>过滤器过滤要基于一套规则。下面我们来看一下HE的规则：</p><blockquote><h1 id="hurricane-electric-route-filtering-algorithm" tabindex="-1"><a class="header-anchor" href="#hurricane-electric-route-filtering-algorithm" aria-hidden="true">#</a> Hurricane Electric Route Filtering Algorithm</h1><p>This is the route filtering algorithm for customers and peers that have explicit filtering:</p><ol><li>Attempt to find an as-set to use for this network.</li></ol><p>1.1 In peeringdb, for this ASN, check for an IRR as-set name. Validate the as-set name by retrieving it. If it exists, use it.</p><p>1.2 In IRR, query for an aut-num for this ASN. If it exists, inspect the aut-num for this ASN to see if we can extract from their IRR policy an as-set for what they will announce to Hurricane by finding export or mp-export to AS6939, ANY, or AS-ANY. Precedence is as follows: The first match is used, &quot;export&quot; is checked before &quot;mp-export&quot;, and &quot;export: to AS6939&quot; is checked before &quot;export: to ANY&quot; or &quot;export: to AS-ANY&quot;. Validate the as-set name by retrieving it. If it exists, use it.</p><p>1.3 Check various internal lists maintained by Hurricane Electric&#39;s NOC that map ASNs to as-set names where we discovered or were told of them. Validate the as-set name by retrieving it. If it exists, use it.</p><p>1.4 If no as-set name is found by the previous steps use the ASN.</p><ol start="2"><li><p>Collect the received routes for all BGP sessions with this ASN. This details both accepted and filtered routes.</p></li><li><p>For each route, perform the following rejection tests:</p></li></ol><p>3.1 Reject default routes 0.0.0.0/0 and ::/0.</p><p>3.2 Reject AS paths that use BGP AS_SET notation (i.e. {1} or {1 2}, etc). See draft-ietf-idr-deprecate-as-set-confed-set.</p><p>3.3 Reject prefix lengths less than minimum and greater than maximum. For IPv4 this is 8 and 24. For IPv6 this is 16 and 48.</p><p>3.4 Reject bogons (RFC1918, documentation prefix, etc).</p><p>3.5 Reject exchange prefixes for all exchanges Hurricane Electric is connected to.</p><p>3.6 Reject AS paths that exceed 50 hops in length. Excessive BGP AS Path Prepending is a Self-Inflicted Vulnerability.</p><p>3.7 Reject AS paths that use unallocated 32-bit ASNs between 1000000 and 4199999999. https://www.iana.org/assignments/as-numbers/as-numbers.xhtml</p><p>3.8 Reject AS paths that use AS 23456. AS 23456 should not be encountered in the AS paths of BGP speakers that support 32-bit ASNs.</p><p>3.9 Reject AS paths that use AS 0. As per RFC 7606, &quot;A BGP speaker MUST NOT originate or propagate a route with an AS number of zero&quot;.</p><p>3.10 Reject routes that have RPKI status INVALID_ASN or INVALID_LENGTH based on the origin AS and prefix.</p><ol start="4"><li>For each route, perform the following acceptance tests:</li></ol><p>4.1 If the origin is the neighbor AS, accept routes that have RPKI status VALID based on the origin AS and prefix.</p><p>4.2 If the prefix is an announced downstream route that is a subnet of an accepted originated prefix that was accepted due to either RPKI or an RIR handle match, accept the prefix.</p><p>4.3 If RIR handles match for the prefix and the peer AS, accept the prefix.</p><p>4.4 If this prefix exactly matches a prefix allowed by the IRR policy of this peer, accept the prefix.</p><p>4.5 If the first AS in the path matches the peer and path is two hops long and the origin AS is in the expanded as-set for the peer AS and either the RPKI status is VALID or there is an RIR handle match for the origin AS and the prefix, accept the prefix.</p><ol start="5"><li>Reject all prefixes not explicitly accepted</li></ol></blockquote><p>翻译</p><blockquote><h1 id="hurricane-electric-的路由过滤算法" tabindex="-1"><a class="header-anchor" href="#hurricane-electric-的路由过滤算法" aria-hidden="true">#</a> Hurricane Electric 的路由过滤算法</h1><p>这是具有显式过滤的客户和对等方的路由过滤列表：</p><p>1.尝试查找该网络的AS-SET</p><p>1.1 使用在PeeringDB中匹配该ASN所属IRR策略中的AS-SET如果它存在</p><p>1.2 在 IRR 中，查询此 ASN 的 aut-num。如果存在，请检查此 ASN 的 aut-num 以查看我们是否可以从他们的 IRR 策略中提取他们将通过查找到 AS6939、ANY 或 AS-ANY 的 export 或 mp-export 向 HE 宣布的内容的资产。 优先顺序如下：使用第一个匹配项，在“mp-export”之前检查“export”，在“export: to ANY”或“export: to AS-ANY”之前检查“export: to AS6939”。 如果存在，请使用查询来验证AS-SET。</p><p>1.3 检查由 HE 的 NOC 维护的各种内部列表，这些列表将 ASN 映射到我们发现或被告知它们的AS-SET。 如果存在，请使用通过查询来验证AS-SET。</p><p>1.4 如果前面的步骤没有找到AS-SET，则使用 ASN。</p><ol start="2"><li><p>收集与此 ASN的所有 BGP 会话接收的路由。这个结果同时接受并进行过滤。</p></li><li><p>对于每条路由，执行以下拒绝测试：</p></li></ol><p>3.1 拒绝默认路由 0.0.0.0/0 和 ::/0。</p><p>3.2 拒绝使用 BGP AS_SET 表示法的 AS 路径（即 {1} 或 {1 2} 等）。请参阅draft-ietf-idr-deprecate-as-set-confed-set。</p><p>3.3 拒绝前缀长度小于最小值和大于最大值。IPV4中为 8 和 24，IPV6为16 和 48。</p><p>3.4 拒绝 bogons（RFC1918、文档前缀等）。</p><p>3.5 拒绝 HE 连接到的所有来自IXP的前缀。</p><p>3.6 拒绝长度超过 50 跳的 AS 路径。过多的 BGP AS 路径预置是一个自我造成的漏洞。</p><p>3.7 拒绝使用 1000000 到 4199999999 之间未分配的 32 位 ASN 中的 AS 路径。 请参阅 https://www.iana.org/assignments/as-numbers/as-numbers.xhtml</p><p>3.8 拒绝使用 AS23456 的 AS 路径。 在支持 32 位 ASN 的 BGP 广播的 AS 路径中不应遇到 AS23456。</p><p>3.9 拒绝使用 AS 0 的 AS 路径。根据 RFC 7606，“BGP 广播者不得发起或传播 AS 编号为零的路由”。</p><p>3.10 拒绝在源ASN或IP前缀的RPKI中含有INVALID_ASN 或 INVALID_LENGTH状态的路由</p><ol start="4"><li>对于每条路由，执行以下接受测试：</li></ol><p>4.1 据源 AS 和前缀接受 RPKI 状态为 VALID 的路由。</p><p>4.2 如果前缀是一个宣布的下游路由并是一个已接受的起源前缀的子网，该前缀由于 RPKI 或 RIR 句柄匹配而被接受，则接受该前缀。</p><p>4.3 如果 RIR 处理前缀和对等 AS 匹配，则接受前缀。</p><p>4.4 如果此前缀与该对等网络的 IRR 策略允许的前缀完全匹配，则接受该前缀。</p><p>4.5 如果路径中的第一个 AS 与对等网络匹配，并且路径为两跳，并且源 AS 在对等 AS 的扩展AS-SET中，并且 RPKI 状态为 VALID 或存在与源 AS 的 RIR 句柄匹配和前缀，接受前缀。</p><ol start="5"><li>拒绝所有未明确接受的前缀</li></ol></blockquote><p>Skywolf 的规则：</p><ol><li>若路由为默认路由，或长度小于最小值/大于最大值，则拒绝。（对于 IPv4，这是 8 和 24。对于 IPv6 来说，这是 16 和 48。）</li><li>若路由的起源ASN为保留ASN，或BGP Path中包含保留ASN，则拒绝。</li><li>若路由为保留前缀，则拒绝。</li><li>若路由的IRR与ASN匹配，且RPKI不为INVALID，则接受。</li></ol><p>总结而言，对于对等与下游，我们只应该接受路由长度大于最小值小于最大值，path内不包含保留ASN，不为保留前缀，且IRR匹配，RPKI不为INVALID的路由。</p><p>而对于上游，我们仅验证RPKI不为INVALID，路由长度大于最小值小于最大值，path内不包含保留ASN，不为保留前缀即可，不必验证IRR。</p><h3 id="上下游对等与自我路由的区分" tabindex="-1"><a class="header-anchor" href="#上下游对等与自我路由的区分" aria-hidden="true">#</a> 上下游对等与自我路由的区分</h3><p>因为如上规则，所以我们需要将上下游对等与自身需要BGP广播出去的路由加以区分。</p><p>我们有两种区分方式：</p><ol><li>通过BGP Community来实现</li><li>通过分表来实现</li></ol><p>在这里，我们仅讲述第一种，有需要可以自己去研究第二种。</p><h3 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h3><p>下面我们将分为常规过滤，RPKI过滤，IRR过滤跟过滤器撰写来一一实现</p><h4 id="常规过滤" tabindex="-1"><a class="header-anchor" href="#常规过滤" aria-hidden="true">#</a> 常规过滤</h4><p>这一部分都是些固定的杂活，直接照抄即可。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>define BOGON_ASNS = [ # 定义保留ASN
    0,                      # RFC 7607
    23456,                  # RFC 4893 AS_TRANS
    64496..64511,           # RFC 5398 and documentation/example ASNs
    64512..65534,           # RFC 6996 Private ASNs
    65535,                  # RFC 7300 Last 16 bit ASN
    65536..65551,           # RFC 5398 and documentation/example ASNs
    65552..131071,          # RFC IANA reserved ASNs
    4200000000..4294967294, # RFC 6996 Private ASNs
    4294967295              # RFC 7300 Last 32 bit ASN
];
define BOGON_PREFIXES_V4 = [ # 定义保留IPv4前缀
    0.0.0.0/8+,             # RFC 1122 &#39;this&#39; network
    10.0.0.0/8+,            # RFC 1918 private space
    100.64.0.0/10+,         # RFC 6598 Carrier grade nat space
    127.0.0.0/8+,           # RFC 1122 localhost
    169.254.0.0/16+,        # RFC 3927 link local
    172.16.0.0/12+,         # RFC 1918 private space 
    192.0.2.0/24+,          # RFC 5737 TEST-NET-1
    192.88.99.0/24{25,32},        # RFC 7526 deprecated 6to4 relay anycast. If you wish to allow this, change `24+` to `24{25,32}`(no more specific)
    192.168.0.0/16+,        # RFC 1918 private space
    198.18.0.0/15+,         # RFC 2544 benchmarking
    198.51.100.0/24+,       # RFC 5737 TEST-NET-2
    203.0.113.0/24+,        # RFC 5737 TEST-NET-3
    224.0.0.0/4+,           # multicast
    240.0.0.0/4+            # reserved
];
define BOGON_PREFIXES_V6 = [ # 定义保留IPv6前缀
    ::/8+,                  # RFC 4291 IPv4-compatible, loopback, et al
    0064:ff9b::/96+,        # RFC 6052 IPv4/IPv6 Translation
    0064:ff9b:1::/48+,      # RFC 8215 Local-Use IPv4/IPv6 Translation
    0100::/64+,             # RFC 6666 Discard-Only
    2001::/32{33,128},      # RFC 4380 Teredo, no more specific
    2001:2::/48+,           # RFC 5180 BMWG
    2001:10::/28+,          # RFC 4843 ORCHID
    2001:db8::/32+,         # RFC 3849 documentation
    2002::/16{17,128},             # RFC 7526 deprecated 6to4 relay anycast. If you wish to allow this, change `16+` to `16{17,128}`(no more specific)
    3ffe::/16+, 5f00::/8+,  # RFC 3701 old 6bone
    fc00::/7+,              # RFC 4193 unique local unicast
    fe80::/10+,             # RFC 4291 link local unicast
    fec0::/10+,             # RFC 3879 old site local unicast
    ff00::/8+               # RFC 4291 multicast
];
function general_check(){ # 返回true则拒绝，返回false则允许
	if bgp_path ~ BOGON_ASNS then return true; # 如果路径包含保留ASN则返回true
    case net.type {
        NET_IP4: return net.len &gt; 24 || net ~ BOGON_PREFIXES_V4; # IPv4 CIDR 大于 /24 为太长
        NET_IP6: return net.len &gt; 48 || net ~ BOGON_PREFIXES_V6; # IPv6 CIDR 大于 /48 为太长
        else: print &quot;unexpected net.type &quot;, net.type, &quot; &quot;, net; return false; # 保底，一般不应该出现非IP4/IP6的前缀。
    }
};
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="rpki-1" tabindex="-1"><a class="header-anchor" href="#rpki-1" aria-hidden="true">#</a> RPKI</h4><p>配置RPKI最简单的方法是使用RTR连接上现有的RPKI验证服务器。在这里，我们会使用Cloudflare的服务器。</p><p>目前而言，公网有大量的前缀没有签署RPKI，所以我们仅拒绝INVALID的路由，允许UNKNOWN与VALID的路由。</p><p>如下所示：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>roa4 table rpki4; # 定义两个ROA表，用来接收RPKI。
roa6 table rpki6; # 定义两个ROA表，用来接收RPKI。

protocol rpki rpki_cloudflare { # 配置RPKI协议示例，取名为rpki_cloudflare
  roa4 {
    table rpki4; # 指定roa表
  };
  roa6 {
    table rpki6; # 指定roa表
  };
  remote &quot;rtr.rpki.cloudflare.com&quot; port 8282; # 指定RTR服务器
  retry keep 5;
  refresh keep 30;
  expire 600;
  transport tcp; 
}
function rpki_check() { # 定义rpki检查函数，如果验证为INVALID则为 true
    if ( net.type = NET_IP4 &amp;&amp; roa_check(rpki4, net, bgp_path.last) = ROA_INVALID ) then {
    return true;
  }
  else if ( net.type = NET_IP6 &amp;&amp; roa_check(rpki6, net, bgp_path.last) = ROA_INVALID ) then {
    return true;
  }
  else {
    return false;
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="irr-1" tabindex="-1"><a class="header-anchor" href="#irr-1" aria-hidden="true">#</a> IRR</h4><p>对于IRR，由于IRR没有一个协议来进行分发，所以我们需要使用如下步骤来生成前缀列表，从而过滤IRR：</p><ol><li>使用比如<code>bgpq4</code>等软件获取ASN/ASSET的IP前缀列表。</li><li>用工具将前缀拼合进如下函数</li><li>与前后拼合，重载bird</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>function irr_check(string as_set) { # 定义IRR检查函数，如果验证正确则返回true
	if net.type = NET_IP4 then { # IPv4检查
		if as_set = &quot;&lt;AS-SET&gt;&quot; then {if net ~ [&lt;前缀IP段&gt;/&lt;前缀长度&gt;{&lt;前缀长度&gt;,24}, &lt;前缀IP段&gt;/&lt;前缀长度&gt;{&lt;前缀长度&gt;,24} ...] then return true;else return false;};
		if as_set = &quot;&lt;AS-SET&gt;&quot; then {if net ~ [&lt;前缀IP段&gt;/&lt;前缀长度&gt;{&lt;前缀长度&gt;,24} ...] then return true;else return false;};
		if as_set = &quot;&lt;AS-SET&gt;&quot; then {if net ~ [&lt;前缀IP段&gt;/&lt;前缀长度&gt;{&lt;前缀长度&gt;,24} ...] then return true;else return false;};
	} else if net.type = NET_IP6 then { # IPv6检查
		if as_set = &quot;&lt;AS-SET&gt;&quot; then {if net ~ [&lt;前缀IP段&gt;/&lt;前缀长度&gt;{&lt;前缀长度&gt;,48} ...] then return true;else return false;};
		if as_set = &quot;&lt;AS-SET&gt;&quot; then {if net ~ [&lt;前缀IP段&gt;/&lt;前缀长度&gt;{&lt;前缀长度&gt;,48} ...] then return true;else return false;};
		if as_set = &quot;&lt;AS-SET&gt;&quot; then {if net ~ [&lt;前缀IP段&gt;/&lt;前缀长度&gt;{&lt;前缀长度&gt;,48} ...] then return true;else return false;};
	} else 
};
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中&lt;&gt;为参数，格式为：</p><ul><li>&lt;AS-SET&gt;: <code>AS114514</code>, <code>AS114514:AS-ALL</code>, <code>AS-SKYWOLF</code></li><li>&lt;前缀IP段&gt;: <code>192.168.0.0</code>或<code>2404::</code></li><li>&lt;前缀长度&gt;: <code>24</code></li></ul><p>至于工具，就交给你们自己去写吧（逃</p><h4 id="过滤器撰写" tabindex="-1"><a class="header-anchor" href="#过滤器撰写" aria-hidden="true">#</a> 过滤器撰写</h4><h1 id="todo" tabindex="-1"><a class="header-anchor" href="#todo" aria-hidden="true">#</a> TODO</h1><p>现在，我们就需要将上面的东西都拼合到一起，从而写出最终的过滤器。</p><p>由于我们的过滤器需要携带参数，所以我们不使用<code>filter</code>，转而使用<code>function</code>，并在编写会话的时候使用<code>where</code>语句来调用。</p><p>如下所示:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>function import_filter_upstream() {

}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: pppwaw@pppwaw.top">pppwaw</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/quickstart/player.html" class="" aria-label="阶段1 BGP Player"><!--[--><!--]--> 阶段1 BGP Player <!--[--><!--]--></a></span><span class="next"><a href="/quickstart/multi_location.html" class="" aria-label="阶段3 多地部署"><!--[--><!--]--> 阶段3 多地部署 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.6747bec2.js" defer></script>
  </body>
</html>
